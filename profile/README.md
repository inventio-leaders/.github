## Рекомендательный сервис прогнозирования возникновения технологических ситуаций Папка backend и frontend.

> Рекурсивная модель на основе LSTM для прогнозирования расхода и детекции аномалий (утечек) в системе ГВС/ХВС.

<p align="center">
  <!-- Замените ссылки на свои -->
  <a href="#"><img alt="build" src="https://img.shields.io/badge/build-passing-brightgreen"></a>
  <a href="#"><img alt="tests" src="https://img.shields.io/badge/tests-120%20passed-blue"></a>
  <a href="#"><img alt="coverage" src="https://img.shields.io/badge/coverage-87%25-blueviolet"></a>
  <a href="#license"><img alt="license" src="https://img.shields.io/badge/license-Apache--2.0-lightgrey"></a>
</p>

---

## Содержание

* [Общее описание](#общее-описание)
* [Ключевые возможности](#ключевые-возможности)
* [Архитектура и модели](#архитектура-и-модели)
* [API](#api)
* [Быстрый старт](#быстрый-старт)
* [Конфигурация](#конфигурация)
* [Данные и подготовка](#данные-и-подготовка)
* [Метрики и результаты](#метрики-и-результаты)
* [Обратная связь и переобучение](#обратная-связь-и-переобучение)
* [RBAC и роли](#rbac-и-роли)
* [Эксплуатация и мониторинг](#эксплуатация-и-мониторинг)
* [Безопасность и соответствие](#безопасность-и-соответствие)
* [Производительность и SLA](#производительность-и-sla)
* [Дорожная карта](#дорожная-карта)
* [Структура репозитория](#структура-репозитория)
* [Разработка и тестирование](#разработка-и-тестирование)
* [FAQ](#faq)
* [Лицензия](#лицензия)
* [Авторы и контакты](#авторы-и-контакты)
* [История версий](#история-версий)

---

## Общее описание

Сервис разработан в рамках технического задания АО «Мосводоканал» на хакатон «Лидеры цифровой трансформации 2025» и предназначен для **раннего выявления аномалий**, **прогнозирования рисков** и **снижения социально-экономических последствий** аварийных ситуаций в системе горячего и холодного водоснабжения. Основная цель — обеспечить устойчивость инфраструктуры за счёт цифровой обработки оперативных и исторических данных, поступающих с узлов учёта (ОДПУ ГВС и водосчётчика ХВС в ИТП).

### Ключевые возможности

* **Раннее выявление аномалий**: утечки, неисправности счётчиков, бездоговорное потребление.
* **Прогнозирование рисков**: учёт сезонности, изменения потребления, внешних факторов.
* **Снижение последствий**: предиктивная диагностика, рекомендации по вмешательству, минимизация простоев и потерь воды.

---

## Архитектура и модели

Сервис основан на глубоком обучении и включает два независимых, но взаимодополняющих модуля.

### 1) Прогнозирование расхода ГВС — NARX‑LSTM

**NARX (Nonlinear Autoregressive with eXogenous inputs)** учитывает:

* прошлые значения расхода ГВС;
* экзогенные переменные: расход ХВС, температуру наружного воздуха, час/день недели.

**Выход:** прогноз объёма ГВС на 1–24 часа (масштабируемо до 168 ч).
**Точность:** `MAE ≈ 0.05 м³/час` при почасовой дискретности.

### 2) Детекция аномалий — LSTM‑Autoencoder

**Принцип:** модель обучается на «нормальных» данных и восстанавливает входной сигнал. Аномалия — высокая ошибка реконструкции.
**Порог:** 99‑й перцентиль ошибки на валидации.

**Ключевой признак:**

```
Delta_GVS_HVS = Q_HVS_ITP - Q_GVS_ODPU
```

Резкий рост `Delta_GVS_HVS` при стабильном потреблении ХВС указывает на утечку в системе ГВС.

### 3) Итеративная обратная связь

Оператор может подтвердить или опровергнуть аномалию в интерфейсе; подтверждения используются для дообучения.

> **Диаграмма архитектуры** (подставьте свой файл): `docs/architecture.png`

---

## API

* **Технология:** FastAPI
* **Базовый URL:** `http://<host>:<port>/api/v1`

**Основные эндпоинты** (пример):

* `POST /forecast` — получить прогноз на 1–24 ч.
* `POST /anomaly/detect` — карта аномалий на интервале.
* `POST /anomaly/feedback` — подтверждение/опровержение аномалии.
* `GET  /metrics` — метрики Prometheus.
* `GET  /healthz` — liveness/readiness.

> Подробная спецификация — `openapi.json` и `docs/`.

---

## Быстрый старт

### Установка

```bash
git clone https://github.com/ВАШ_ЛОГИН/water-analysis-service.git
cd water-analysis-service
python -m venv venv
source venv/bin/activate      # macOS/Linux
# venv\Scripts\activate      # Windows
pip install -r requirements.txt
```

### Локальный запуск

```bash
uvicorn app.main:app --reload --port 8000
```

### Docker

```bash
docker build -t water-service:local .
docker run -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  --env-file .env \
  water-service:local
```

---

## Данные и подготовка

### Ожидаемые файлы (Excel → `data/raw/`)

* `Посуточная ведомость водосчетчика ХВС ИТП.xlsx`
* `Посуточная ведомость ОДПУ ГВС.xlsx`

### Предобработка

Скрипт `preprocessing.py`:

* объединяет данные по времени;
* рассчитывает `Delta_GVS_HVS`;
* заполняет пропуски;
* нормализует признаки.

### Запуск анализа

Скрипт `analyze.py`:

* обучает (или загружает) модели;
* строит прогноз и карту аномалий;
* сохраняет графики в `output/`.

---

## Метрики и результаты

| Модуль              | Метрика                      | Значение     |
| ------------------- | ---------------------------- | ------------ |
| NARX‑LSTM (прогноз) | MAE                          | ~0.05 м³/час |
|                     | MAPE                         | < 3%         |
| LSTM‑AE (аномалии)  | Recall (на тестовых утечках) | 92%          |
|                     | False Alarm Rate             | < 5%         |
|                     | Время обнаружения            | < 2 часов    |

---

## Обратная связь и переобучение

* Оператор просматривает аномалию в интерфейсе.
* При подтверждении — событие пишется в `labelled_anomalies.csv` с меткой `true_positive`.
* Раз в месяц (или по кнопке) запускается `feedback_loop.py`:

  * объединяет исторические и новые данные;
  * дообучает LSTM‑AE с повышенным весом подтверждённых кейсов;
  * обновляет порог аномалии;
  * заменяет модель в прод.

---

## RBAC и роли

> Базируется на модели ролей проекта.

**Роли:**

* **Диспетчер** — просмотр дашбордов, подтверждение/отклонение аномалий.
* **Старший диспетчер** — всё из «Диспетчер» + запуск ручного анализа, экспорт отчётов, **право переобучать модель**.
* **Администратор** — управление конфигурацией/доступами/моделями, **право переобучать модель**.

**Гранулярные права (пример):**

* `anomaly:read`, `anomaly:confirm`, `anomaly:export`
* `model:train`, `model:deploy`, `config:write`
* `system:users:manage`, `system:audit:read`

---

## Эксплуатация и мониторинг

* **Логи:** структурированные JSON‑логи (`app/logger.py`).
* **Метрики:** Prometheus (`/metrics`), графики — Grafana.
* **Алерты:** правило по росту `Delta_GVS_HVS`, SLA‑латентность, частота ложных срабатываний.
* **Трассировка:** OpenTelemetry (опционально).

---

## Безопасность и соответствие

* Соответствие ФЗ‑152; персональные данные **не обрабатываются**.
* RBAC, аудит операций, иммутабельные артефакты моделей.
* Секреты только через `.env`/Secret Manager; без жёстко закодированных ключей.

---

## Производительность и SLA

* **SLA:** отчёт ≤10 сек (MVP: < 3 сек на сегмент).
* **Нагрузка:** до 500 rps (требуется FastAPI + кэширование; work‑in‑progress).
* Профилирование и кэш FE/BE описаны в `docs/perf.md`.

---

## Дорожная карта

* [ ] Кэширование прогнозов на горячем горизонте.
* [ ] Онлайн‑оценка доверительных интервалов.
* [ ] Автоматическая калибровка порога под сезонность.
* [ ] Экспорт инцидентов в внешние СЭД/ITSM.

---

## Структура репозитория

```
water-analysis-service/
├─ app/
│  ├─ api/                # эндпоинты FastAPI
│  ├─ core/               # конфигурация, логирование
│  ├─ ml/                 # модели, обучение, инференс
│  ├─ services/           # доменная логика (анализ, feedback)
│  ├─ schemas/            # Pydantic-схемы
│  └─ main.py             # точка входа FastAPI
├─ data/
│  ├─ raw/                # исходные Excel
│  └─ processed/          # подготовленные датасеты
├─ models/                # веса и артефакты моделей
├─ docs/                  # документация, диаграммы
├─ output/                # графики и отчёты
├─ scripts/
│  ├─ preprocessing.py
│  ├─ analyze.py
│  └─ feedback_loop.py
├─ tests/
├─ requirements.txt
├─ .env.example
└─ README.md
```

---

## FAQ

**Q:** Что, если нет температуры наружного воздуха?
**A:** Модель работает и без неё; точность может слегка снизиться. Возможно включение суррогатных признаков (сезон/месяц).

**Q:** Как понять, что аномалия «реальная»?
**A:** Смотрите на рост `Delta_GVS_HVS` при стабильном `Q_HVS_ITP` и подтверждения оператора.

---

## Лицензия

Проект распространяется по лицензии **Apache‑2.0**. См. раздел `LICENSE`.

---

## Авторы и контакты

**Команда разработки «Inventio»**

Telegram: [@oliceglad](@oliceglad)

---

## История версий

* **v1.1** — актуальные метрики, описан RBAC, добавлены эндпоинты `/metrics`, `/healthz`.
* **v1.0** — MVP: прогноз + детекция аномалий, оффлайн‑подготовка данных.
